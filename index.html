<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plomow ‚Äì Web MVP</title>
  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js"></script>
  <!-- Mapbox GL Draw -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <!-- Turf.js for geometry math -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <!-- React via CDN (quick MVP). In production, use Vite/Next. -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root { --bg:#0b0f14; --card:#111826; --muted:#93a3b3; --accent:#3aa3ff; }
    html,body,#root { height:100%; margin:0; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:#e6eef8; }
    .map-wrap { position:fixed; inset:0; }
    #map { position:absolute; inset:0; }
    .panel { position:fixed; left:12px; right:12px; bottom:12px; z-index:5; display:grid; gap:10px; }
    .card { background:rgba(17,24,38,.9); backdrop-filter: saturate(140%) blur(6px); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:12px; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .controls button { border:1px solid rgba(255,255,255,.12); background:#0f1522; color:#e6eef8; padding:10px 12px; border-radius:12px; font-weight:600; }
    .controls button.primary { background:var(--accent); color:#001428; border-color:transparent; }
    .controls button:disabled { opacity:.5; }
    .badge { font-size:12px; color:var(--muted); }
    .pill { background:#0f1522; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.08); }
    .stack { display:grid; gap:6px; }
    .heading { font-weight:700; font-size:16px; }
    .brand { position:fixed; top:12px; left:12px; z-index:5; padding:8px 12px; border-radius:12px; background:rgba(17,24,38,.85); border:1px solid rgba(255,255,255,.06); }
    .brand b { letter-spacing:.5px }
    .toast { position:fixed; top:12px; right:12px; z-index:6; background:#0f1522; border:1px solid rgba(255,255,255,.08); padding:10px 12px; border-radius:12px; display:none }
    .draw-hint { position:fixed; top:60px; left:12px; z-index:5; padding:8px 10px; background:rgba(17,24,38,.85); border:1px solid rgba(255,255,255,.06); border-radius:10px; font-size:12px; color:#c9d4e0; }
    /* Make Mapbox Draw buttons minimal on mobile */
    .mapbox-gl-draw_ctrl-draw-btn { width:36px; height:36px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useRef, useState } = React;

    function currency(n){ return `$${n.toFixed(2)}` }

    function priceEstimate(service, areaM2, edgeM){
      const cfg = {
        snow:   { base:25, perM2:0.02, perM:0.30 },
        lawn:   { base:20, perM2:0.015, perM:0.00 },
        leaves: { base:15, perM2:0.012, perM:0.00 },
        salt:   { base:10, perM2:0.008, perM:0.10 },
      }[service];
      const raw = cfg.base + cfg.perM2*areaM2 + cfg.perM*edgeM;
      return Math.max(raw, cfg.base);
    }

    function App(){
      const mapRef = useRef(null);
      const drawRef = useRef(null);
      const [mapReady, setMapReady] = useState(false);
      const [service, setService] = useState('snow');
      const [address, setAddress] = useState('');
      const [metrics, setMetrics] = useState({ areaM2:0, areaFt2:0, edgeM:0, edgeFt:0 });
      const [price, setPrice] = useState(0);
      const [featureId, setFeatureId] = useState(null);

      useEffect(()=>{
        // TODO: replace with your token
        mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN_HERE';
        const map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [-81.233, 42.983], // London, ON
          zoom: 13,
          attributionControl: false
        });
        map.addControl(new mapboxgl.AttributionControl({ compact: true }));
        map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }));

        const draw = new MapboxDraw({
          displayControlsDefault: false,
          controls: {}, // we‚Äôll trigger via our own buttons
          defaultMode: 'simple_select',
          styles: [
            // polygon fill
            { id:'gl-draw-polygon-fill', type:'fill', filter:['all',['==','$type','Polygon'],['!=','mode','static']], paint:{ 'fill-color':'#3aa3ff', 'fill-opacity':0.2 }},
            // polygon outline
            { id:'gl-draw-polygon-stroke', type:'line', filter:['all',['==','$type','Polygon'],['!=','mode','static']], paint:{ 'line-color':'#3aa3ff', 'line-width':2 }},
            // line
            { id:'gl-draw-line', type:'line', filter:['all',['==','$type','LineString'],['!=','mode','static']], paint:{ 'line-color':'#3aa3ff', 'line-width':2 }},
          ]
        });
        map.addControl(draw);

        map.on('load', ()=> setMapReady(true));

        function updateMetrics(){
          const sel = draw.getSelected();
          const all = draw.getAll();
          let f = sel.features[0] || (featureId && all.features.find(x=>x.id===featureId));
          if(!f){ setMetrics({ areaM2:0, areaFt2:0, edgeM:0, edgeFt:0 }); setPrice(0); return; }
          let areaM2 = 0, edgeM = 0;
          if(f.geometry.type === 'Polygon'){
            areaM2 = turf.area(f); // m¬≤
            edgeM = turf.length(turf.polygonToLine(f), { units:'meters' });
          } else if (f.geometry.type === 'LineString'){
            areaM2 = 0;
            edgeM = turf.length(f, { units:'meters' });
          }
          const areaFt2 = areaM2 * 10.7639;
          const edgeFt = edgeM * 3.28084;
          setMetrics({ areaM2, areaFt2, edgeM, edgeFt });
          setPrice(priceEstimate(service, areaM2, edgeM));
        }

        map.on('draw.create', e=>{ setFeatureId(e.features[0].id); updateMetrics(); });
        map.on('draw.update', updateMetrics);
        map.on('draw.selectionchange', updateMetrics);

        mapRef.current = map; drawRef.current = draw;

        return ()=>{ map.remove(); }
      },[]);

      useEffect(()=>{ // recompute price if service changes
        setPrice(priceEstimate(service, metrics.areaM2, metrics.edgeM));
      }, [service, metrics.areaM2, metrics.edgeM]);

      function startPolygon(){ drawRef.current?.changeMode('draw_polygon'); }
      function startLine(){ drawRef.current?.changeMode('draw_line_string'); }
      function finish(){ drawRef.current?.changeMode('simple_select'); }
      function undo(){ try { drawRef.current?.trash(); setFeatureId(null); setMetrics({ areaM2:0, areaFt2:0, edgeM:0, edgeFt:0 }); setPrice(0);} catch(e){} }
      function clearAll(){ const ids = drawRef.current?.getAll().features.map(f=>f.id) || []; ids.forEach(id=>drawRef.current.delete(id)); setFeatureId(null); setMetrics({ areaM2:0, areaFt2:0, edgeM:0, edgeFt:0 }); setPrice(0); }

      function saveQuote(){
        const payload = {
          service,
          address,
          areaM2: Math.round(metrics.areaM2),
          areaFt2: Math.round(metrics.areaFt2),
          edgeM: Math.round(metrics.edgeM),
          edgeFt: Math.round(metrics.edgeFt),
          price: Number(price.toFixed(2)),
          geometry: drawRef.current?.getAll()
        };
        console.log('Plomow Quote ‚Üí', payload);
        // TODO: POST to your API / Firebase
        const t = document.getElementById('toast');
        t.style.display='block'; t.textContent='Quote saved (console)';
        setTimeout(()=> t.style.display='none', 1500);
      }

      return (
        <>
          <div className="brand"><b>PLOMOW</b> <span className="badge">web MVP</span></div>
          <div id="toast" className="toast">toast</div>
          <div className="draw-hint">Tap Add Area or Add Edge, then tap to place points. Tap again to continue. Tap first point to close polygon. Hit Finish when done.</div>
          <div className="map-wrap"><div id="map"></div></div>

          <div className="panel">
            <div className="card stack">
              <div className="row">
                <select value={service} onChange={e=>setService(e.target.value)} className="pill">
                  <option value="snow">‚ùÑ Snow Removal</option>
                  <option value="lawn">üå± Lawn Cutting</option>
                  <option value="leaves">üçÇ Leaf Cleanup</option>
                  <option value="salt">üßÇ Salting</option>
                </select>
                <input className="pill" placeholder="Address (optional)" value={address} onChange={e=>setAddress(e.target.value)} />
              </div>
              <div className="row controls">
                <button onClick={startPolygon}>+ Add Area</button>
                <button onClick={startLine}>+ Add Edge</button>
                <button onClick={finish}>Finish</button>
                <button onClick={undo}>Undo</button>
                <button onClick={clearAll}>Clear</button>
              </div>
              <div className="row" style={{alignItems:'center'}}>
                <div className="pill" style={{textAlign:'center'}}>
                  <div className="badge">Area</div>
                  <div><b>{Math.round(metrics.areaM2)}</b> m¬≤ ‚Ä¢ <b>{Math.round(metrics.areaFt2)}</b> ft¬≤</div>
                </div>
                <div className="pill" style={{textAlign:'center'}}>
                  <div className="badge">Edge</div>
                  <div><b>{Math.round(metrics.edgeM)}</b> m ‚Ä¢ <b>{Math.round(metrics.edgeFt)}</b> ft</div>
                </div>
                <div className="pill" style={{textAlign:'center'}}>
                  <div className="badge">Estimate</div>
                  <div><b>{currency(price || 0)}</b></div>
                </div>
              </div>
              <div className="row controls">
                <button className="primary" onClick={saveQuote} disabled={!(metrics.areaM2>0 || metrics.edgeM>0)}>Request Service</button>
              </div>
            </div>
          </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
